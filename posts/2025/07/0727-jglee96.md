# ë°°ì—´ì˜ ê¸´ ì‘ì—… ìµœì í™”

ê¸€: [Breaking Up with Long Tasks or: how I learned to group loops and wield the yield](https://calendar.perfplanet.com/2024/breaking-up-with-long-tasks-or-how-i-learned-to-group-loops-and-wield-the-yield/)

## ìœ ì € ê²½í—˜ì„ í•´ì¹˜ëŠ” ê¸´ ì‘ì—… (Long Tasks)

- ë°°ì—´ì€ ë§¤ìš° ìì£¼ ì“°ì´ëŠ” ë„êµ¬ì´ë©°, ì´ë¥¼ ìˆœíšŒí•˜ëŠ” ë°©ë²•ì€ ì•„ì£¼ ë§ìŒ
- ì˜ëª» ì‚¬ìš©í•˜ë©´ ì´ë¥¼ ìˆœíšŒí•˜ëŠ” ëŒ€ë¶€ë¶„ì˜ ë°©ë²•ë“¤ì´ í•˜ë‚˜ì˜ ê¸´ blocking taskë¥¼ ë™ê¸°ì ìœ¼ë¡œ ë°œìƒì‹œí‚´
- ë¬¸ì œëŠ” `for..of`, `forEach`. `map` ê³¼ ê°™ì€ **ìì—°ìŠ¤ëŸ¬ìš´** ë°©ë²•ë“¤ì´ ì˜ëª»ëœ ë°©ë²•ìœ¼ë¡œ ë™ì‘í•¨
- ì´ëŠ” ìœ ì €ì—ê²Œ ì‘ë‹µí•˜ì§€ ì•ŠëŠ” í™”ë©´ì„ ì œê³µí•˜ê³ , INP(Interaction to Next Pain)ë¥¼ ëŠë¦¬ê²Œ í•¨

## Interaction ë°˜ì‘ ìµœì í™”

- yielding: ì´ë²¤íŠ¸ ë£¨í”„ê°€ ê³„ì† ë™ì‘í•˜ë„ë¡ ì‘ì—…ì„ ì¤‘ë‹¨í•˜ëŠ” ê²ƒ
- yield ë°©ë²•
  - delayë¥¼ 0msë¡œ ì„¤ì •í•œ setTimeout
  - ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘í•˜ì§€ ì•Šì§€ë§Œ, scheduler.yield
    > scheduler.yield()
    > í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ taskë¥¼ ì¼ì‹œì ìœ¼ë¡œ ì¤‘ë‹¨í•˜ì—¬ ë¸Œë¼ìš°ì €ê°€ ë‹¤ë¥¸ ì‘ì—…ì„ ë¨¼ì € ì§„í–‰í•  ê¸°íšŒë¥¼ ì œê³µ
    > -> ì´ë²¤íŠ¸ ë£¨í”„ì—ê²Œ ì œì–´ê¶Œì„ ë„˜ê¹€

### forEachëŠ” ê¸°ë‹¤ë ¤ì£¼ì§€ ì•Šì•„

```js
function handleClick() {
  items.forEach(async (item) => {
    await scheduler.yield();
    process(item);
  });
}
```

- `forEach`ëŠ” ì½œë°±ì´ ë¹„ë™ê¸° í•¨ìˆ˜ì¸ì§€ ìƒê´€í•˜ì§€ ì•ŠìŒ, yield ì‹¤í–‰ì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë°°ì—´ì„ ìˆœíšŒí•¨
- exmpale ì‹¤í–‰ì‹œê°„: **916.60 ms**

### for..of ëŠ” ê¸°ë‹¤ë ¤ì¤˜

```js
async function handleClick() {
  for (const item of items) {
    await scheduler.yield();
    process(item);
  }
}
```

- ì´ì œ ë™ì‘í•¨, ë‚¨ì€ê±´ í° í•˜ë‚˜ì˜ ì‘ì—…ì„ ì—¬ëŸ¬ê°œì˜ ì‘ì€ ì‘ì—…ìœ¼ë¡œ ë‚˜ëˆ„ì–´ interactionì‹œì— ë°”ë¡œ ë°˜ì‘í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒ
- exmpale ì‹¤í–‰ì‹œê°„: **1.17 s**

### reduceë¥¼ ì¨ë³´ì

```js
function handleClick() {
  items.reduce(async (promise, item) => {
    await promise;
    await scheduler.yield();
    process(item);
  }, Promise.resolve());
}
```

- ê¸€ì“´ì´ëŠ” ë§Œì•½ í•¨ìˆ˜í˜• í”„ë¡œê·¸ë˜ë°ì— ëŒ€í•œ ì§‘ì°©ìœ¼ë¡œ ì´ ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤ë©´ ë‹¤ì‹œ ìƒê°í•´ë³´ë¼ê³  í•¨
- ì´ ë°©ë²•ì€ ë¶„í• í•œ promiseë¥¼ ë‹¤ìŒ ìˆœíšŒì— ë„˜ê¸´ ê²ƒì„
- ì–´ì¨Œë“  ë°°ì—´ì„ ë™ê¸°ì ìœ¼ë¡œ ìˆœíšŒí•˜ë©° microtaskë¥¼ queueì— ë„£ê³  ìˆìŒ. ì´ ìˆœíšŒê°€ ì˜¤ë˜ ê±¸ë¦°ë‹¤ë©´ í´ë¦­ ë™ì‘ì´ ëŠë ¤ì§
- exmpale ì‹¤í–‰ì‹œê°„: **266.90 ms**

### yieldë¥¼ ëª»ì“°ëŠ” ìƒí™©ì´ë©´?

```js
async function handleClick() {
  for (const item of items) {
    await Promise((resolve) => setTimeout(resolve, 0));
    process(item);
  }
}
```

- yield ëŒ€ì‹  setTimeoutì„ ì“°ë‹ˆ 2ë¶„ ë„˜ê²Œ ì†Œìš”ë¨!
- ì´ í°ì°¨ì´ëŠ” [nested timeouts](https://developer.mozilla.org/en-US/docs/Web/API/Window/setTimeout#reasons_for_delays_longer_than_specified)ì— ì˜í•´ ìƒê¹€
  - ë¸Œë¼ìš°ì €ì—ì„œ setTimeoutì´ 5ë²ˆ ì˜ˆì•½ë˜ë©´ ìµœì†Œ 4msì˜ delayë¥¼ ê°•ì œ ì ìš©í•¨
- exmpale ì‹¤í–‰ì‹œê°„: **2.3 min**

## ì „ì²´ ì‹œê°„ ìµœì í™”

- íŠ¹ì • í¬ê¸°ë¡œ ì ìš©í•  ìˆ˜ ìˆê² ì§€ë§Œ, ìœ ì € í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ë™ì‘í•  ê²ƒì„
- ì†Œìš”ì‹œê°„ìœ¼ë¡œ batch ì‹œì  ì •í•˜ê¸°

```js
const BATCH_DURATION = 50;
let timeOfLastYield = performance.now();

function shouldYield() {
  const now = performance.noe();
  if ((now = timeOfLastYield > BATCH_DURATION)) {
    timeOfLastYield = now;
    return true;
  }
  return false;
}

async function handleClick() {
  for (const item of items) {
    if (shouldYield()) {
      await scheduler.yield();
    }
    process(item);
  }
}
```

- yield exmpale ì‹¤í–‰ì‹œê°„: **781.80 ms**
- setTimeout exmpale ì‹¤í–‰ì‹œê°„: **1.28 s**
- batch ì‚¬ì´ì¦ˆëŠ” ì „ì²´ ì‹œê°„ì„ ì¤„ì¼ì§€, ìœ ì €ê°€ ê¸°ë‹¤ë ¤ì•¼ í•˜ëŠ” ì‹œê°„ì„ ì¤„ì¼ì§€ ì‚¬ì´ì˜ tradeoffì„

## Smoothness ìµœì í™”

- ì´ì „ ìµœì í™” ë‹¨ê³„ì—ì„œ ë©ˆì¶œ ìˆ˜ë„ ìˆìœ¼ë‚˜ frame rateë„ ê³ ë ¤í•´ì•¼í•¨
  - setTimeoutê³¼ scheduler.yieldì˜ frame rateê°€ ë‹¤ë¦„
  - ì‘ì—…ì„ ë¹¨ë¦¬ ëë‚´ì•¼ í•˜ëŠ” ê²½ìš° batchë¥¼ í‚¤ì›Œ yieldë¥¼ ìµœì†Œí™” í™”ë©´ ë¨
  - ê·¸ëŸ¬ë‚˜ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•œ ê²½ìš° frame rateë¥¼ ì ë‹¹íˆ ìœ ì§€í•˜ëŠ”ê²Œ ì¢‹ìŒ
    ![image](./0727-jglee96.png)
- scheduler.yieldëŠ” ìš°ì„  ì²˜ë¦¬ë˜ë¯€ë¡œ batchë¥¼ ì ìš©í•˜ì§€ ì•Šë”ë¼ë„ frame rateê°€ ë‚®ê²Œ ì¸¡ì •ë¨
- ë³€ê²½ ë°©ì•ˆ
  - ì›í•˜ëŠ” í”„ë ˆì„ ì†ë„ì— ë§ì¶° batch duration ì¡°ì ˆ
  - scheduler.yieldë¥¼ í˜¸ì¶œí•˜ê¸°ì „ requestAnimateFrameì½œë°±ì—ì„œ await promise

```js
const BATCH_DURATION = 1000/ 30; // 30 FPS
let timeOfLastYield = performance.now();

function shouldYield() {
  const now = performance.now();
  if (now - timeOfLastYield > (document.hidden ? 500 : BATCH_DURATION)) {
    timeOfLastYield = now;
    return true;
  }
  retunr false;
}

async function handleClick() {
  for (const item of items) {
    if (shoudYield()) {
      if (document.hidden) {
        await new Promise(resolve => setTimeout(resolve, 1));
        timeOfLastYield = performance.now();
      } else {
        await Promise.race([
          new Promise(resolve => setTimeout(resolve, 100)),
          new Promise(requestAnimationFrame)
        ]);
        timeOfLastYield = performance.now();
        await scheduler.yield();
      }
    }
    process(item);
  }
}
```

- page visibilityë¥¼ ì²´í¬í•´ì„œ ìœ ì €ê°€ ë³´ê³ ìˆì§€ ì•Šìœ¼ë©´ batch í¬ê¸°ë¥¼ ëŠ˜ë¦¼
- ìœ ì €ì—ê²Œ ë³´ì¼ ë–„ëŠ” vercelì˜ [await-intercation-response](https://vercel.com/blog/demystifying-inp-new-tools-and-actionable-insights#the-implementation) ì ‘ê·¼ì„ ì¸ìš©í•˜ì—¬ 100 msë³´ë‹¤ ëŠë¦° requestAnimationFrameëŠ” ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ

## ëŠë‚€ ì 

- ê¸€ì“´ì´ê°€ ë§ˆì§€ë§‰ì— ë§í•œ ê²ƒì²˜ëŸ¼ ê³¼ë„í•œ ì‘ì—…ì´ë¼ê³  ìƒê°ë˜ì§€ë§Œ, ìœ ì €ì—ê²Œ ë¼ì¹˜ëŠ” ì˜í–¥ì„ ê³ ë ¤í•˜ì—¬ ì ìš©í•´ë³¼ë§Œí•œ ì‘ì—…ì¸ ê²ƒ ê°™ìŒ
- yieldë¥¼ í‰ì†Œì— ì˜ ì“°ì§€ ì•Šê³  ìˆì—ˆìŒ. scheduler apiì— ëŒ€í•´ì„œë„ ì•Œì•„ë³¼ í•„ìš”ê°€ ìˆìŒ
  #the-fullswing
